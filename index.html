<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Lavoro - GitHub Sync</title>
    <style>
        /* INCOLLA TUTTI GLI STILI CSS CHE TI HO DATO PRIMA */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .config-section, .main-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .work-day {
            background-color: #f9f9f9;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .total-section {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .alert-info {
            background-color: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        
        .github-info {
            background-color: #f3f4f6;
            border-left: 4px solid #24292e;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Registro Lavoro - GitHub Sync</h1>
            <p>I dati salvati direttamente sul tuo repository GitHub</p>
        </header>

        <!-- Sezione configurazione GitHub -->
        <section id="configSection" class="config-section">
            <h2>‚öôÔ∏è Configurazione GitHub</h2>
            
            <div class="github-info">
                <p><strong>Come ottenere il Token:</strong></p>
                <ol>
                    <li>Vai su GitHub ‚Üí Settings ‚Üí Developer settings</li>
                    <li>Personal access tokens ‚Üí Tokens (classic)</li>
                    <li>Crea nuovo token con scopo <strong>"repo"</strong></li>
                    <li>Copia il token generato</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="githubToken">Token GitHub:</label>
                <input type="password" id="githubToken" placeholder="Incolla il tuo token GitHub">
            </div>
            
            <div class="form-group">
                <label for="repoName">Repository Name:</label>
                <input type="text" id="repoName" placeholder="es: ale208-tech/registro-lavoro" value="ale208-tech/registro-lavoro">
            </div>
            
            <button id="saveConfigBtn" class="btn-success">Salva Configurazione</button>
            <div id="configAlert" class="alert alert-info"></div>
        </section>

        <!-- Sezione principale -->
        <section id="mainSection" class="main-section hidden">
            <button id="logoutBtn" class="logout-btn">Logout</button>
            <h2>üëã Benvenuto!</h2>
            
            <!-- Form per aggiungere lavoro -->
            <div class="form-group">
                <h3>‚ûï Aggiungi Giorno di Lavoro</h3>
                <label for="workDate">Data:</label>
                <input type="date" id="workDate">
                
                <label for="dailyPay">Paga Giornaliera (‚Ç¨):</label>
                <input type="number" id="dailyPay" placeholder="Inserisci la paga" min="0" step="0.01">
                
                <label for="workNotes">Note:</label>
                <textarea id="workNotes" placeholder="Cosa hai fatto oggi..."></textarea>
                
                <button id="addWorkDayBtn" class="btn-success">Aggiungi Giorno</button>
                <div id="addAlert" class="alert alert-success hidden"></div>
            </div>
            
            <!-- Sincronizzazione GitHub -->
            <div class="form-group">
                <h3>üîÑ Sincronizzazione GitHub</h3>
                <button id="loadFromGitHubBtn" class="btn-warning">üì• Carica da GitHub</button>
                <button id="saveToGitHubBtn" class="btn-success">üì§ Salva su GitHub</button>
                <div id="syncAlert" class="alert alert-info hidden"></div>
            </div>
            
            <!-- Storico -->
            <div class="work-days-list">
                <h3>üìÖ Storico Giorni di Lavoro</h3>
                <div id="workDaysList"></div>
                
                <div id="totalSection" class="total-section hidden">
                    <h3>üí∞ Riepilogo</h3>
                    <p>Totale giorni: <span id="totalDays">0</span></p>
                    <p>Guadagno totale: ‚Ç¨<span id="totalEarnings">0.00</span></p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Elementi DOM
        const configSection = document.getElementById('configSection');
        const mainSection = document.getElementById('mainSection');
        const githubTokenInput = document.getElementById('githubToken');
        const repoNameInput = document.getElementById('repoName');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const configAlert = document.getElementById('configAlert');
        const logoutBtn = document.getElementById('logoutBtn');
        const workDate = document.getElementById('workDate');
        const dailyPay = document.getElementById('dailyPay');
        const workNotes = document.getElementById('workNotes');
        const addWorkDayBtn = document.getElementById('addWorkDayBtn');
        const addAlert = document.getElementById('addAlert');
        const loadFromGitHubBtn = document.getElementById('loadFromGitHubBtn');
        const saveToGitHubBtn = document.getElementById('saveToGitHubBtn');
        const syncAlert = document.getElementById('syncAlert');
        const workDaysList = document.getElementById('workDaysList');
        const totalSection = document.getElementById('totalSection');
        const totalDays = document.getElementById('totalDays');
        const totalEarnings = document.getElementById('totalEarnings');

        // Variabili globali
        let githubToken = null;
        let repoName = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            workDate.value = new Date().toISOString().split('T')[0];
            
            // Carica configurazione salvata
            githubToken = localStorage.getItem('githubToken');
            repoName = localStorage.getItem('repoName') || 'ale208-tech/registro-lavoro';
            
            if (githubToken && repoName) {
                repoNameInput.value = repoName;
                configSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                loadUserData();
            }
            
            setupEventListeners();
        });

        function setupEventListeners() {
            saveConfigBtn.addEventListener('click', saveConfig);
            logoutBtn.addEventListener('click', logout);
            addWorkDayBtn.addEventListener('click', addWorkDay);
            loadFromGitHubBtn.addEventListener('click', loadFromGitHub);
            saveToGitHubBtn.addEventListener('click', saveToGitHub);
        }

        function saveConfig() {
            githubToken = githubTokenInput.value.trim();
            repoName = repoNameInput.value.trim();
            
            if (!githubToken) {
                showAlert(configAlert, 'Inserisci il token GitHub', 'error');
                return;
            }
            
            if (!repoName) {
                showAlert(configAlert, 'Inserisci il nome del repository', 'error');
                return;
            }
            
            localStorage.setItem('githubToken', githubToken);
            localStorage.setItem('repoName', repoName);
            
            configSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            loadUserData();
            
            showAlert(configAlert, 'Configurazione salvata!', 'success');
        }

        function logout() {
            localStorage.removeItem('githubToken');
            localStorage.removeItem('repoName');
            localStorage.removeItem('workData');
            mainSection.classList.add('hidden');
            configSection.classList.remove('hidden');
            githubTokenInput.value = '';
        }

        function addWorkDay() {
            const date = workDate.value;
            const pay = parseFloat(dailyPay.value);
            const notes = workNotes.value.trim();
            
            if (!date || isNaN(pay) || pay <= 0) {
                alert('Inserisci data e paga validi');
                return;
            }
            
            const workDay = {
                id: Date.now(),
                date: date,
                pay: pay,
                notes: notes
            };
            
            const userData = JSON.parse(localStorage.getItem('workData')) || [];
            userData.push(workDay);
            localStorage.setItem('workData', JSON.stringify(userData));
            
            showAlert(addAlert, '‚úÖ Giorno aggiunto!', 'success');
            dailyPay.value = '';
            workNotes.value = '';
            loadUserData();
        }

        async function saveToGitHub() {
            if (!githubToken || !repoName) {
                showAlert(syncAlert, 'Configura prima GitHub', 'error');
                return;
            }
            
            try {
                showAlert(syncAlert, 'üì§ Salvando su GitHub...', 'info');
                
                const userData = JSON.parse(localStorage.getItem('workData')) || [];
                const content = btoa(JSON.stringify(userData, null, 2));
                
                // Controlla se il file esiste gi√†
                let sha = null;
                try {
                    const existingFile = await githubApiRequest(`/repos/${repoName}/contents/work-data.json`);
                    sha = existingFile.sha;
                } catch (error) {
                    // File non esiste, va bene
                }
                
                // Salva il file
                const response = await githubApiRequest(`/repos/${repoName}/contents/work-data.json`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Aggiornamento dati lavoro - ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                showAlert(syncAlert, '‚úÖ Dati salvati su GitHub!', 'success');
                
            } catch (error) {
                showAlert(syncAlert, '‚ùå Errore: ' + error.message, 'error');
                console.error('GitHub error:', error);
            }
        }

        async function loadFromGitHub() {
            if (!githubToken || !repoName) {
                showAlert(syncAlert, 'Configura prima GitHub', 'error');
                return;
            }
            
            try {
                showAlert(syncAlert, 'üì• Caricando da GitHub...', 'info');
                
                const response = await githubApiRequest(`/repos/${repoName}/contents/work-data.json`);
                const content = atob(response.content);
                const userData = JSON.parse(content);
                
                localStorage.setItem('workData', JSON.stringify(userData));
                showAlert(syncAlert, '‚úÖ Dati caricati da GitHub!', 'success');
                loadUserData();
                
            } catch (error) {
                if (error.message.includes('404')) {
                    showAlert(syncAlert, '‚ÑπÔ∏è Nessun dato trovato su GitHub. Salva prima i dati.', 'info');
                } else {
                    showAlert(syncAlert, '‚ùå Errore: ' + error.message, 'error');
                }
            }
        }

        async function githubApiRequest(endpoint, options = {}) {
            const url = `https://api.github.com${endpoint}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                },
                ...options
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }

        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('workData')) || [];
            
            userData.sort((a, b) => new Date(b.date) - new Date(a.date));
            workDaysList.innerHTML = '';
            
            let totalDaysCount = 0;
            let totalEarningsCount = 0;
            
            if (userData.length === 0) {
                workDaysList.innerHTML = '<p>Nessun giorno di lavoro registrato.</p>';
                totalSection.classList.add('hidden');
                return;
            }
            
            userData.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'work-day';
                
                const dateObj = new Date(day.date);
                const formattedDate = dateObj.toLocaleDateString('it-IT', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                dayElement.innerHTML = `
                    <button class="delete-btn" onclick="deleteWorkDay(${day.id})">Elimina</button>
                    <h3>${formattedDate}</h3>
                    <p><strong>Paga:</strong> ‚Ç¨${day.pay.toFixed(2)}</p>
                    <p><strong>Note:</strong> ${day.notes || 'Nessuna nota'}</p>
                `;
                
                workDaysList.appendChild(dayElement);
                totalDaysCount++;
                totalEarningsCount += day.pay;
            });
            
            totalSection.classList.remove('hidden');
            totalDays.textContent = totalDaysCount;
            totalEarnings.textContent = totalEarningsCount.toFixed(2);
        }

        function deleteWorkDay(workDayId) {
            const userData = JSON.parse(localStorage.getItem('workData')) || [];
            const updatedData = userData.filter(day => day.id !== workDayId);
            localStorage.setItem('workData', JSON.stringify(updatedData));
            loadUserData();
        }

        function showAlert(alertElement, message, type) {
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.classList.remove('hidden');
            
            if (type !== 'error') {
                setTimeout(() => {
                    alertElement.classList.add('hidden');
                }, 5000);
            }
        }

        // Funzioni globali
        window.deleteWorkDay = deleteWorkDay;
    </script>
</body>
</html>
